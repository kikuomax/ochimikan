<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="text/javascript" src="libs/jquery-1.11.1.min.js"></script>
  <script type="text/javascript" src="libs/knockout-3.2.0.js"></script>
  <script type="text/javascript" src="mikan.debug.js"></script>
  <script type="text/javascript">
    $(function () {
        function TestCanvas() {}
        TestCanvas.augment = function (canvas) {
            var directionListeners = [];
            canvas.addDirectionListener = function (listener) {
                directionListeners.push(listener);
            };
            canvas.removeDirectionListener = function (listener) {
                var idx = directionListeners.indexOf(listener);
                if (idx != -1) {
                    directionListener.splice(idx, 1);
                }
            };

            if ('ontouchstart' in document.documentElement) {
                canvas.addEventListener('touchstart',  handleTouchStart, false);
                canvas.addEventListener('touchmove',   handleTouchMove,  false);
                canvas.addEventListener('touchend',    handleTouchEnd,   false);
                canvas.addEventListener('touchleave',  handleTouchEnd,   false);
                canvas.addEventListener('touchcancel', handleTouchEnd,   false);
            } else {
                canvas.addEventListener('mousedown',  handleStart, false);
                canvas.addEventListener('mousemove',  handleMove,  false);
                canvas.addEventListener('mouseup',    handleEnd,   false);
                canvas.addEventListener('mouseleave', handleEnd,   false);
            }

            var touchId = -1;
            function handleTouchStart(evt) {
                if (touchId === -1) {
                    var touch = evt.changedTouches[0];
                    touchId = touch.identifier;
                    evt.x = touch.pageX;
                    evt.y = touch.pageY;
                    handleStart(evt);
                }
            }

            function handleTouchMove(evt) {
                var touches = evt.changedTouches;
                for (var i = 0; i < touches.length; ++i) {
                    var touch = touches[i];
                    if (touch.identifier === touchId) {
                        evt.x = touch.pageX;
                        evt.y = touch.pageY;
                        handleMove(evt);
                    }
                }
            }

            function handleTouchEnd(evt) {
                var touches = evt.changedTouches;
                for (var i = 0; i < touches.length; ++i) {
                    var touch = touches[i];
                    if (touch.identifier === touchId) {
                        touchId = -1;
                        evt.x = touch.pageX;
                        evt.y = touch.pageY;
                        handleEnd(evt);
                    }
                }
            }
 
            var isDown = false;
            var downTimeStamp = 0;
            var moved = false;
            var x, y;
            function handleStart(evt) {
                evt.preventDefault();
                isDown = true; 
                downTimeStamp = evt.timeStamp;
                moved = false;
                x = evt.x;
                y = evt.y;
            }

            function handleMove(evt) {
                if (isDown) {
                    evt.preventDefault();
                    var dX = evt.x - x;
                    var dY = evt.y - y;
                    var notification;
                    if (Math.abs(dX) > Math.abs(dY)) {
                        if (Math.abs(dX) > 15) {
                            if (dX < 0) {
                                notification = 'moveLeft';
                            } else {
                                notification = 'moveRight';
                            }
                        }
                    } else {
                        if (Math.abs(dY) > 30) {
                            if (dY < 0) {
                                notification = 'rotateCounterClockwise';
                            } else {
                                notification = 'rotateClockwise';
                            }
                        }
                    }
                    if (notification) {
                        directionListeners.forEach(function (listener) {
                            listener[notification](canvas);
                        });
                        moved = true;
                        x = evt.x;
                        y = evt.y;
                    }
                }
            }

            function handleEnd(evt) {
                evt.preventDefault();
                isDown = false;
                if (!moved && evt.timeStamp - downTimeStamp < 200) {
                    directionListeners.forEach(function (listener) {
                        listener.releaseControl(canvas);
                    });
                }
            }

            return canvas;
        };

        var statistics = new Statistics();

        var canvas = document.getElementById('mikanCanvas');
        var game = Game.start(TestCanvas.augment(canvas), new ResourceManager(), statistics);

        function ViewModel() {
            var self = this;

            self.score = ko.observable(statistics.score);
            self.level = ko.observable(statistics.level + 1);

            statistics.addObserver(function (id) {
                switch (id) {
                case 'scoreUpdated':
                    self.score(statistics.score);
                    break;
                case 'levelUpdated':
                    self.level(statistics.level + 1);
                    break;
                case 'statisticsReset':
                    self.score(statistics.score);
                    self.level(statistics.level + 1);
                    break;
                }
            });

            self.restart = function () {
                statistics.reset();
                game.restart();
            };
        }
        ko.applyBindings(new ViewModel());
    })
  </script>
  <title>落ちみかん</title>
</head>
<body> 
  <div>
    <span style="float: left">Score: </span>
    <span style="float: left; width: 5em; text-align: right"
          data-bind="text: score"></span>
    <span style="float: left; margin-left: 1em">Level: </span>
    <span style="float: left; width: 2em; text-align: right"
          data-bind="text: level"></span>
  </div>
  <div style="clear: both">
    <canvas id="mikanCanvas"
            style="background-image: url('imgs/background.png')">
    </canvas>
  </div>
  <div>
    <button data-bind="click: restart">Restart</button>
  </div>
</body>
</html>
