<html>
<head>
  <meta charset="UTF-8">
  <script type="text/javascript" src="../dist/libs/jquery-1.11.1.min.js"></script>
  <script type="text/javascript" src="../dist/libs/knockout-3.2.0.js"></script>
  <script type="text/javascript" src="../dist/mikan.debug.js"></script>
  <script type="text/javascript">
    $(function () {
        function SpecResourceManager() {
            var self = this;

            ResourceManager.call(self);

            Properties.override(self, 'loadImage', function (path) {
                return self.loadImage._super('../dist/' + path);
            });
        }
        ResourceManager.augment(SpecResourceManager.prototype);

        var directionListeners = [];
        function TestCanvas() {}
        TestCanvas.augment = function(canvas) {
            canvas.addDirectionListener = function(listener) {
                directionListeners.push(listener);
            };
            canvas.removeDirectionListener = function(listener) {
                var idx = directionListeners.indexOf(listener);
                if (idx != -1) {
                    directionListener.splice(idx, 1);
                }
            };
            return canvas;
        };

        var scoreObj = new Score();

        var canvas = document.getElementById('mikanCanvas');
        TestCanvas.augment(canvas);
        Game.start(canvas, new SpecResourceManager(), scoreObj);
        window.setInterval(function() {
            var directionId = Math.floor(4 * Math.random());
            var direction = [
                'moveLeft', 'moveRight',
                'rotateClockwise', 'rotateCounterClockwise'
            ][directionId];
            directionListeners.forEach(function(listener) {
                listener[direction](canvas);
            });
        }, 10);

        function ViewModel() {
            var self = this;

            self.score = ko.observable(scoreObj.score);
            scoreObj.addObserver(function () {
                console.log('score updated: ' + scoreObj.score);
                self.score(scoreObj.score);
            });
        }

        ko.applyBindings(new ViewModel());
    });
 </script>
  <title>落ちみかん(セレンディピティ)</title>
</head>
<body>
  <div>
    Score: <span data-bind="text: score"></span>
  </div>
  <canvas id="mikanCanvas"
          style="background-image: url('../dist/imgs/background.png')">
  </canvas>
</body>
</html>
